name: Xcode - CI

on:
  workflow_dispatch:

env:
  PROJECT_NAME: "Embrace Ecommerce"
  XCODE_VERSION: "16.4"

jobs:
  single-demo:
    runs-on: macos-latest
    timeout-minutes: 50

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Configure App with Repository Variables
      run: |
        # Check if APP_ID variable exists
        if [[ -n "${{ vars.APP_ID }}" ]]; then
          sed -i '' 's/static let appId = "YOUR_EMBRACE_APP_ID"/static let appId = "${{ vars.APP_ID }}"/' "Embrace Ecommerce/Services/SDKConfiguration.swift"
          echo "โ APP_ID configured"
        else
          echo "โ ERROR: APP_ID variable not found in repository variables"
          exit 1
        fi

        # Set RUN_SOURCE to ci_action
        if sed -i '' 's/"RUN_SOURCE": "[^"]*"/"RUN_SOURCE": "ci_action"/' "Embrace EcommerceUITests/Embrace_EcommerceUITests.swift"; then
          echo "โ RUN_SOURCE set to ci_action"
        else
          echo "โ๏ธ WARNING: Failed to set RUN_SOURCE"
        fi

    - name: Set up Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
        xcodebuild -version

    - name: Find and Boot Simulator
      id: setup_simulator
      run: |
        # Get valid destination from xcodebuild
        DESTINATION_LINE=$(xcodebuild -showdestinations -project "${{ env.PROJECT_NAME }}.xcodeproj" -scheme "${{ env.PROJECT_NAME }}" 2>&1 | grep "iPhone" | grep "platform:iOS Simulator" | head -1)

        if [[ -z "$DESTINATION_LINE" ]]; then
          echo "โ No iPhone simulator found"
          exit 1
        fi

        # Extract the ID from the destination line
        SIMULATOR_UDID=$(echo "$DESTINATION_LINE" | grep -o 'id:[A-F0-9-]*' | cut -d: -f2)

        if [[ -z "$SIMULATOR_UDID" ]]; then
          echo "โ Could not extract simulator ID"
          exit 1
        fi

        echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT

        # Boot the simulator
        xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || true
        xcrun simctl bootstatus "$SIMULATOR_UDID" -b

    - name: Build for Testing
      run: |
        xcodebuild build-for-testing \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.PROJECT_NAME }}" \
          -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
          -configuration Debug \
          -enableCodeCoverage NO \
          -allowProvisioningUpdates \
          -skipMacroValidation \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

    - name: Run UI Test with SDK Logging
      run: |
        echo "๐งช Running demo test with Embrace SDK logging..."
        SIMULATOR_UDID="${{ steps.setup_simulator.outputs.simulator_udid }}"
        PROJECT_NAME="${{ env.PROJECT_NAME }}"
        SCHEME="${{ env.PROJECT_NAME }}"
        TEST_CLASS="Embrace_EcommerceUITests"
        TEST_METHOD="testFlow"

        # Start capturing Embrace SDK logs in background (app + test runner)
        # Note: This captures OSLog/unified logging, but NOT stdout print() statements
        # stdout from xcodebuild test will be captured separately
        echo "๐ Starting Embrace SDK log capture..."
        log stream \
          --predicate 'processImagePath CONTAINS "Embrace" AND (process CONTAINS "Embrace Ecommerce" OR process CONTAINS "EcommerceUITests")' \
          --level debug \
          --style compact > embrace_sdk.log 2>&1 &

        LOG_PID=$!
        echo "Log capture PID: $LOG_PID"

        # Wait for log stream to initialize
        sleep 2

        # Run the test (capture stdout to see print() statements)
        echo "โถ๏ธ  Executing UI test..."
        xcodebuild test-without-building \
          -project "$PROJECT_NAME.xcodeproj" \
          -scheme "$SCHEME" \
          -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
          -only-testing:"Embrace EcommerceUITests/$TEST_CLASS/$TEST_METHOD" 2>&1 | tee xcodebuild_output.log

        echo "โ Test completed successfully"

        # Wait for any remaining uploads (increased to 20s to allow termination uploads)
        echo "โณ Waiting 20 seconds for SDK uploads to complete..."
        sleep 20

        # Inspect session data BEFORE stopping log capture and cleaning up
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ EMBRACE SDK SESSION DATA INSPECTION"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""

        # Find the app's data container
        APP_CONTAINER=$(xcrun simctl get_app_container "$SIMULATOR_UDID" "com.embrace.org.Embrace-Ecommerce" data 2>/dev/null || echo "")

        if [[ -n "$APP_CONTAINER" ]]; then
          echo "โ Found app container: $APP_CONTAINER"
          echo ""

          # Look for Embrace SDK data directories
          echo "๐ Checking Library directory..."
          if [[ -d "$APP_CONTAINER/Library" ]]; then
            echo "Library contents:"
            ls -la "$APP_CONTAINER/Library" 2>/dev/null || echo "  Unable to list Library"
            echo ""

            # Check for Embrace-specific directories
            echo "๐ Looking for Embrace SDK data..."
            find "$APP_CONTAINER/Library" -name "*mbrace*" -o -name "*otel*" -o -name "*.sqlite*" 2>/dev/null | while read -r file; do
              echo "  Found: $file"
              if [[ -f "$file" && "$file" == *.sqlite* ]]; then
                echo "    Size: $(du -h "$file" | cut -f1)"
              fi
            done
            echo ""

            # Check Caches directory
            if [[ -d "$APP_CONTAINER/Library/Caches" ]]; then
              echo "๐ฆ Caches directory contents:"
              ls -la "$APP_CONTAINER/Library/Caches" 2>/dev/null || echo "  Unable to list Caches"
              echo ""
            fi

            # Check Application Support directory
            if [[ -d "$APP_CONTAINER/Library/Application Support" ]]; then
              echo "๐ฆ Application Support directory contents:"
              ls -la "$APP_CONTAINER/Library/Application Support" 2>/dev/null || echo "  Unable to list Application Support"
              echo ""
            fi
          else
            echo "โ๏ธ  Library directory not found"
          fi
        else
          echo "โ Could not find app container"
        fi
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""

        # Stop log capture
        echo "๐ Stopping log capture..."
        kill $LOG_PID 2>/dev/null || true
        sleep 1

    - name: Analyze Embrace SDK Logs
      if: always()
      run: |
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ EMBRACE SDK LOG ANALYSIS"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""

        if [[ ! -f embrace_sdk.log ]]; then
          echo "โ SDK log file not found!"
          exit 1
        fi

        echo "๐ Total log lines captured: $(wc -l < embrace_sdk.log)"
        echo ""

        # Check for SDK initialization (look in OSLog - using logger.info/error messages)
        echo "๐ Checking SDK initialization..."
        if grep -q "EMBRACE_INIT: SDK initialized successfully" embrace_sdk.log 2>/dev/null; then
          echo "โ SDK initialized (found in OSLog)"
          echo ""
          echo "App ID used:"
          grep "EMBRACE_INIT: Configuring SDK with App ID" embrace_sdk.log 2>/dev/null || echo "  App ID line not found"
          echo ""
          echo "Environment detection:"
          grep "EMBRACE_INIT: Environment check" embrace_sdk.log 2>/dev/null || echo "  No environment check logs"
          echo ""
          echo "Session properties:"
          grep "EMBRACE_INIT: Session property" embrace_sdk.log 2>/dev/null || echo "  No session property logs"
          echo ""
          echo "All SDK initialization messages:"
          grep "EMBRACE_INIT:" embrace_sdk.log 2>/dev/null || echo "  No EMBRACE_INIT messages"
        else
          echo "โ SDK initialization not detected in OSLog"
          echo ""
          echo "Checking for initialization errors:"
          grep "EMBRACE_INIT: CRITICAL ERROR" embrace_sdk.log 2>/dev/null || echo "  No initialization errors found"
          echo ""
          echo "Checking if any EMBRACE_INIT messages appear in logs:"
          grep "EMBRACE_INIT" embrace_sdk.log 2>/dev/null | head -20 || echo "  No EMBRACE_INIT messages found in OSLog"
        fi
        echo ""

        # Check for test lifecycle events
        echo "๐ Checking test lifecycle..."
        if grep -q "TEST_LIFECYCLE:" embrace_sdk.log 2>/dev/null; then
          echo "Test lifecycle events detected:"
          grep "TEST_LIFECYCLE:" embrace_sdk.log 2>/dev/null | head -20
        else
          echo "โ๏ธ  No test lifecycle events found"
        fi
        echo ""

        # Check for session lifecycle
        echo "๐ Checking session lifecycle..."
        echo "Session events:"
        grep -i "session" embrace_sdk.log | head -10 || echo "  No session events found"
        echo ""

        # Check for upload attempts
        echo "๐ Checking upload operations..."
        if grep -q "Upload operation" embrace_sdk.log; then
          echo "โ Upload operations detected:"
          grep "Upload operation" embrace_sdk.log
        else
          echo "โ No upload operations found in logs"
        fi
        echo ""

        # Check for successful uploads (HTTP 2xx status codes)
        echo "๐ Checking for successful uploads..."
        if grep -E "Upload operation complete.*Status: 2[0-9]{2}" embrace_sdk.log; then
          echo "โโโ SUCCESSFUL UPLOADS DETECTED! โโโ"
          UPLOAD_COUNT=$(grep -cE "Upload operation complete.*Status: 2[0-9]{2}" embrace_sdk.log)
          echo "๐ Number of successful uploads: $UPLOAD_COUNT"
        else
          echo "โ No successful uploads (Status 2xx) found"
        fi
        echo ""

        # Check for upload failures
        echo "๐ Checking for upload failures..."
        if grep -E "Upload operation complete.*Status: [45][0-9]{2}" embrace_sdk.log; then
          echo "โ๏ธ  Failed uploads detected:"
          grep -E "Upload operation complete.*Status: [45][0-9]{2}" embrace_sdk.log
        else
          echo "โ No failed uploads"
        fi
        echo ""

        # Check for network errors
        echo "๐ Checking for network errors..."
        if grep -i "error.*network\|network.*error\|connection.*failed" embrace_sdk.log; then
          echo "โ๏ธ  Network errors detected:"
          grep -i "error.*network\|network.*error\|connection.*failed" embrace_sdk.log | head -5
        else
          echo "โ No network errors detected"
        fi
        echo ""

        # Show upload URLs
        echo "๐ Upload endpoints used:"
        grep -o "https://[^ ]*data.emb-api.com[^ ]*" embrace_sdk.log | sort -u || echo "  No URLs found"
        echo ""

        # Show full log for debugging (last 50 lines)
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ FULL SDK LOG (last 50 lines):"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        tail -50 embrace_sdk.log
        echo ""
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

    - name: Cleanup
      if: always()
      run: |
        echo "๐งน Cleaning up..."

        # Kill all simulator processes
        echo "๐งน Stopping all Simulator processes..."
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown all 2>/dev/null || true

        # Delete the simulator we created (if it still exists)
        SIMULATOR_UDID="${{ steps.setup_simulator.outputs.simulator_udid }}"
        if [[ -n "$SIMULATOR_UDID" ]]; then
          echo "๐งน Deleting simulator $SIMULATOR_UDID..."
          xcrun simctl delete "$SIMULATOR_UDID" 2>/dev/null || true
        fi

        # Clean up log files
        echo "๐งน Cleaning up log files..."
        rm -f embrace_sdk.log 2>/dev/null || true

        echo "โ Cleanup complete"
