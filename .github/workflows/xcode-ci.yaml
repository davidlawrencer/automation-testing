name: Xcode - CI

on:
  workflow_dispatch:

env:
  PROJECT_NAME: "Embrace Ecommerce"
  XCODE_VERSION: "16.4"

jobs:
  xcode-ci:
    runs-on: macos-latest
    timeout-minutes: 50

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Configure App with Repository Variables
      run: |
        # Check if APP_ID variable exists
        if [[ -n "${{ vars.APP_ID }}" ]]; then
          sed -i '' 's/static let appId = "YOUR_EMBRACE_APP_ID"/static let appId = "${{ vars.APP_ID }}"/' "Embrace Ecommerce/Services/SDKConfiguration.swift"
          echo "✅ APP_ID configured"
        else
          echo "❌ ERROR: APP_ID variable not found in repository variables"
          exit 1
        fi

        # Set RUN_SOURCE to ci_action
        if sed -i '' 's/"RUN_SOURCE": "[^"]*"/"RUN_SOURCE": "ci_action"/' "Embrace EcommerceUITests/Embrace_EcommerceUITests.swift"; then
          echo "✅ RUN_SOURCE set to ci_action"
        else
          echo "⚠️ WARNING: Failed to set RUN_SOURCE"
        fi

    - name: Set up Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
        xcodebuild -version

    - name: Find and Boot Simulator
      id: setup_simulator
      run: |
        # Get valid destination from xcodebuild
        DESTINATION_LINE=$(xcodebuild -showdestinations -project "${{ env.PROJECT_NAME }}.xcodeproj" -scheme "${{ env.PROJECT_NAME }}" 2>&1 | grep "iPhone" | grep "platform:iOS Simulator" | head -1)

        if [[ -z "$DESTINATION_LINE" ]]; then
          echo "❌ No iPhone simulator found"
          exit 1
        fi

        # Extract the ID from the destination line
        SIMULATOR_UDID=$(echo "$DESTINATION_LINE" | grep -o 'id:[A-F0-9-]*' | cut -d: -f2)

        if [[ -z "$SIMULATOR_UDID" ]]; then
          echo "❌ Could not extract simulator ID"
          exit 1
        fi

        echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT

        # Boot the simulator
        xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || true
        xcrun simctl bootstatus "$SIMULATOR_UDID" -b

    - name: Build for Testing
      run: |
        xcodebuild build-for-testing \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.PROJECT_NAME }}" \
          -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
          -configuration Debug \
          -enableCodeCoverage NO \
          -allowProvisioningUpdates \
          -skipMacroValidation \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

    - name: Run UI Test with SDK Logging
      run: |
        # Start capturing Embrace SDK logs in background
        log stream \
          --predicate 'processImagePath CONTAINS "Embrace" AND (process CONTAINS "Embrace Ecommerce" OR process CONTAINS "EcommerceUITests")' \
          --level debug \
          --style compact > embrace_sdk.log 2>&1 &

        LOG_PID=$!

        # Run the test
        xcodebuild test-without-building \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.PROJECT_NAME }}" \
          -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
          -only-testing:"Embrace EcommerceUITests/Embrace_EcommerceUITests/testFlow" 2>&1 | tee xcodebuild_output.log

        # Stop log capture
        kill $LOG_PID 2>/dev/null || true

    - name: Analyze Embrace SDK Logs
      if: always()
      run: |
        if [[ ! -f embrace_sdk.log ]]; then
          echo "❌ SDK log file not found!"
          exit 1
        fi

        # Check for successful uploads (HTTP 2xx status codes)
        if grep -E "Upload operation complete.*Status: 2[0-9]{2}" embrace_sdk.log; then
          echo "✅ SUCCESSFUL UPLOADS DETECTED"
          UPLOAD_COUNT=$(grep -cE "Upload operation complete.*Status: 2[0-9]{2}" embrace_sdk.log)
          echo "Number of successful uploads: $UPLOAD_COUNT"
        else
          echo "❌ No successful uploads (Status 2xx) found"
        fi

        # Check for upload failures
        if grep -E "Upload operation complete.*Status: [45][0-9]{2}" embrace_sdk.log; then
          echo "⚠️ Failed uploads detected:"
          grep -E "Upload operation complete.*Status: [45][0-9]{2}" embrace_sdk.log
        fi

        # Check for network errors
        if grep -i "error.*network\|network.*error\|connection.*failed" embrace_sdk.log; then
          echo "⚠️ Network errors detected:"
          grep -i "error.*network\|network.*error\|connection.*failed" embrace_sdk.log | head -5
        fi

    - name: Cleanup
      if: always()
      run: |
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown all 2>/dev/null || true
        xcrun simctl delete "${{ steps.setup_simulator.outputs.simulator_udid }}" 2>/dev/null || true
        rm -f embrace_sdk.log xcodebuild_output.log 2>/dev/null || true
