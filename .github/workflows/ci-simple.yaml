name: Simple Demo - Single Session

on:
  workflow_dispatch:

env:
  PROJECT_NAME: "Embrace Ecommerce"

jobs:
  single-demo:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Configure App with Repository Variables
      run: |
        echo "ðŸ”§ Configuring app with repository variables..."
        # Check if APP_ID variable exists
        if [[ -n "${{ vars.APP_ID }}" ]]; then
          echo "âœ… APP_ID found in repository variables: ${{ vars.APP_ID }}"
          # Update the SDK configuration file
          echo "ðŸ“ Updating SDKConfiguration.swift..."
          sed -i '' 's/static let appId = "YOUR_EMBRACE_APP_ID"/static let appId = "${{ vars.APP_ID }}"/' "Embrace Ecommerce/Services/SDKConfiguration.swift"
          echo "âœ… Updated SDK configuration"
          # Show the updated line for verification
          echo "ðŸ“‹ Updated line:"
          grep -n "static let appId" "Embrace Ecommerce/Services/SDKConfiguration.swift" || echo "âš ï¸ Could not find appId line"
        else
          echo "âŒ ERROR: APP_ID variable not found in repository variables"
          echo "   Please add APP_ID as a repository variable before running this workflow."
          echo "   Go to Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab"
          exit 1
        fi
        echo ""

        # Set RUN_SOURCE to ci_action
        echo "ðŸ“ Configuring UITest to use ci_action as RUN_SOURCE..."
        sed -i '' 's/"RUN_SOURCE": "[^"]*"/"RUN_SOURCE": "ci_action"/' "Embrace EcommerceUITests/Embrace_EcommerceUITests.swift"
        echo "âœ… RUN_SOURCE set to ci_action"
        echo ""

    - name: Set up Xcode
      run: |
        sudo xcode-select --print-path
        echo "ðŸ› ï¸  Xcode Version: $(xcodebuild -version | head -1)"

    - name: Find and Boot Simulator
      id: setup_simulator
      run: |
        echo "ðŸ” Finding iPhone simulator..."
        PROJECT_NAME="${{ env.PROJECT_NAME }}"
        SCHEME="${{ env.PROJECT_NAME }}"

        # Get valid destination from xcodebuild
        DESTINATION_LINE=$(xcodebuild -showdestinations -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME" 2>&1 | grep "iPhone" | grep "platform:iOS Simulator" | head -1)

        if [[ -z "$DESTINATION_LINE" ]]; then
          echo "âŒ No iPhone simulator found"
          exit 1
        fi

        # Extract the ID from the destination line
        SIMULATOR_UDID=$(echo "$DESTINATION_LINE" | grep -o 'id:[A-F0-9-]*' | cut -d: -f2)

        if [[ -z "$SIMULATOR_UDID" ]]; then
          echo "âŒ Could not extract simulator ID"
          exit 1
        fi

        echo "âœ… Found simulator with ID: $SIMULATOR_UDID"
        echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT

        # Boot the simulator
        echo "â³ Starting simulator..."
        xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || echo "Already booted"
        xcrun simctl bootstatus "$SIMULATOR_UDID" -b > /dev/null 2>&1 || true
        echo "âœ… Simulator is ready"

    - name: Verify Network Connectivity
      run: |
        echo "ðŸŒ Verifying network connectivity..."

        # Test 1: CI runner can reach internet
        echo "ðŸ“¡ Testing CI runner network..."
        if curl -s --max-time 10 https://www.google.com > /dev/null; then
          echo "âœ… CI runner has internet access"
        else
          echo "âŒ CI runner cannot reach internet"
          exit 1
        fi

        # Test 2: CI runner can reach Embrace endpoints
        echo "ðŸ“¡ Testing Embrace API endpoints..."
        EMBRACE_API="https://api.embrace.io"
        if curl -s --max-time 10 -I "$EMBRACE_API" | head -1; then
          echo "âœ… Can reach Embrace API"
        else
          echo "âš ï¸  Cannot reach Embrace API (may be expected if endpoint requires auth)"
        fi

        # Test 3: Check DNS resolution
        echo "ðŸ“¡ Testing DNS resolution..."
        if nslookup embrace.io > /dev/null 2>&1; then
          echo "âœ… DNS resolution working"
        else
          echo "âŒ DNS resolution failed"
        fi

        # Test 4: Simulator network test (install test app that makes network request)
        echo "ðŸ“¡ Testing simulator network access..."
        SIMULATOR_UDID="${{ steps.setup_simulator.outputs.simulator_udid }}"

        # Open Safari in simulator to test networking
        xcrun simctl openurl "$SIMULATOR_UDID" "https://www.google.com" || echo "âš ï¸  Could not open URL in simulator"

        echo "âœ… Network verification complete"

    - name: Build for Testing
      run: |
        echo "ðŸ”¨ Building the app..."
        SIMULATOR_UDID="${{ steps.setup_simulator.outputs.simulator_udid }}"

        xcodebuild build-for-testing \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.PROJECT_NAME }}" \
          -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
          -configuration Debug \
          -enableCodeCoverage NO \
          -allowProvisioningUpdates \
          -skipMacroValidation \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

        echo "âœ… Build completed successfully"

    - name: Run UI Test
      run: |
        echo "ðŸ§ª Running demo test..."
        SIMULATOR_UDID="${{ steps.setup_simulator.outputs.simulator_udid }}"
        PROJECT_NAME="${{ env.PROJECT_NAME }}"
        SCHEME="${{ env.PROJECT_NAME }}"
        TEST_CLASS="Embrace_EcommerceUITests"
        TEST_METHOD="testFlow"

        xcodebuild test-without-building \
          -project "$PROJECT_NAME.xcodeproj" \
          -scheme "$SCHEME" \
          -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
          -only-testing:"Embrace EcommerceUITests/$TEST_CLASS/$TEST_METHOD"

        echo "âœ… Test completed successfully"

    - name: Wait for SDK Upload and Verify
      if: always()
      run: |
        echo "â³ Waiting for Embrace SDK to complete uploads..."

        # Wait 10 seconds for background uploads to complete
        sleep 10

        echo "ðŸ“Š Checking for network activity..."

        # Check if there were any network errors in system logs
        echo "ðŸ” Checking system logs for network issues..."
        log show --predicate 'process == "Embrace Ecommerce"' --last 5m --info 2>/dev/null | grep -i "network\|upload\|embrace" | tail -20 || echo "No relevant logs found"

        # Test if Embrace endpoints are still reachable
        echo "ðŸ“¡ Final connectivity check to Embrace API..."
        curl -s --max-time 5 -I https://api.embrace.io | head -1 || echo "âš ï¸  Could not reach Embrace API"

        echo "âœ… Upload verification complete"

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown all 2>/dev/null || true
        echo "âœ… Cleanup complete"
